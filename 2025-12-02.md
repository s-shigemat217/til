# 2025-12-01 スッキリわかるSQL入門 第4版②
## 第2部 SQLを使いこなそう
### Chapter5 式と関数
#### 5.1 式と演算子
##### 5.1.1 式の種類
結果が真や偽にならない式を計算式と呼ぶ。
##### 5.1.2 選択列リストで計算式を使う
SELECT文において、SELECTのすぐ後ろに指定するのが選択列リスト。選択列リストは、結果表にどのような列を出力するかを指定する役割がある。
▼選択列リストへのさまざまな指定
```SQL
SELECT 出金額,--列名
	   出金額 + 100,--計算式
	   'SQL' --固定値
   FROM 家計簿
```

**選択列リストへの指定と結果**
列名→列の内容がそのまま出力される
計算式→計算式の評価結果が出力される
固定値→固定値（リテラル）がそのまま出力される

##### 5.1.3 データの代わりに計算式を使う
▼INSERT文での計算式の利用
```SQL
INSERT INTO 家計簿（出金額）
VALUES (1000 + 105)
```
▼UPDATE文での計算式の利用（列指定を含む）
```SQL
UPDATE 家計簿
SET 出金額 = 出金額 + 100
```
##### 5.1.4 式が評価されるしくみ
**DBMSによる処理の原則**
- DBMSは、テーブル内の各行を1行ずつ順番に処理していく。
- 式の評価なども、各行で行われる。
#### 5.2 さまざまな演算子
##### 5.2.1 基本の算術演算子

| 演算子  | 使い方          | 説明           |
| ---- | ------------ | ------------ |
| ＋    | 数値＋数値        | 数値同士で足し算をする  |
|      | 日付＋数値        | 日付を指定日数だけ進める |
| ー    | 数値ー数値        | 数値同士で引き算をする  |
|      | 日付ー数値        | 日付を指定日数だけ戻す  |
|      | 日付ー日付        | 日付の差の日数を得る   |
| *    | 数値 * 数値      | 数値同士で掛け算をする  |
| /    | 数値 / 数値      | 数値同士で割り算     |
| \|\| | 文字列 \|\| 文字列 | 文字列を連結する     |

##### 5.2.2 CASE演算子 ー 値を変換する
CASE演算子は、列の値や条件式を評価し、その結果に応じて値を自由に変換してくれる。
**▼CASE演算子の利用構文（１）**
```SQL
CASE 評価する列や式 WHEN 値1 THEN 値1のときに返す値
				　WHEN 値2 THEN 値2のときに返す値
				　ELSE デフォルト値
END
```
▼CASE演算子を使ったSELECT文
```SQL
SELECT 費目, 出金額,
CASE 費目 WHEN '居住費' THEN '固定費'
		 WHEN '水道光熱費' THEN '固定費'
		 ELSE '変動費'
	END AS 出費の分類
	FROM 家計簿 WHERE 出金額 > 0
```

▼CASE演算子の利用構文(2)
```SQL
CASE WHEN 条件1 THEN 条件1のときに返す値
	 WHEN 条件2 THEN 条件2のときに返す値
	 ELSE デフォルト値
END
```
CASEのすぐ後ろに列名や式を記述しない代わりに、WHENの後ろには値ではなく条件式を指定する。
▼CASE演算子を使ったSELECT文(2)
```SQL
SELECT 費目, 入金額,
CASE WHEN 入金額 < 5000 THEN 'お小遣い'
	 WHEN 入金額 < 10000 THEN '一時収入'
	 WHEN 入金額 < 30000 THEN 'お給料'
	 ELSE '想定外の収入です'
END AS 収入の分類
FROM 家計簿
WHERE 入金額 > 0
```

CASE演算子は、式の結果に応じて複数のパターンの結果を得たい場合に有効。
#### 5.3 さまざまな関数

##### 5.3.1 関数とは
多くのデータベースには、より高度な処理を手軽に実現できる関数と総称される命令がたくさん準備されている。
すべての関数は「呼び出し時に指定した情報（引数）に対して、定められて処理を行い、結果（戻り値）に変換する」という動作をする。
##### 5.3.2 関数の使い方
**関数について定められていること**
- 名前：関数の名前
- 引数：関数を呼び出す時に引き渡す情報
- 戻り値：関数の呼び出し結果として得られる情報

**LENGTH関数の仕様**
- 名前：LENGTH
- 引数：文字列が格納された列（または式）
- 戻り値：文字列の長さを表す数値

▼メモとメモの長さを表示する
```SQL
SELECT メモ, LENGTH(メモ) AS メモの長さ
FROM 家計簿
```
##### 5.3.3 関数が動作する流れ
式の評価と同様に、関数の呼び出しも各行ごとに繰り返し行われる。
関数呼び出しの記述は、呼び出し完了後、戻り値に「化ける」。この特性を利用して、関数の呼び出しを入れ子にすることもできる。
##### 5.3.4 関数にまつわる注意点
日付型の取り扱いなどと並んで、**関数はDBMSごとの違いが大きく、互換性が少ない**分野。特定の製品でのみ利用可能な関数や、製品によって名前や動作が異なる関数も多く存在する。
#### 5.4 文字列にまつわる関数
##### 5.4.1 LENGTH／LEN ー 長さを得る
SQL Serverでは、LENGTHの代わりにLEN関数を利用。
テーブルの列に格納されている文字列の長さを取得したい、取得した長さを使って検索や更新したい、などの場合に利用する。
**▼文字列の長さを得る関数**
```SQL
LENGTH(文字列を表す列) → 文字列の長さを表す数値
LEN(文字列を表す列) → 文字列の長さを表す数値
```

**▼10文字（10バイト）以下のメモだけを取得する**
```SQL
SELECT メモ, LENGTH(メモ) AS メモの長さ FROM 家計簿
WHERE LENGHTH(メモ) <= 10
```

##### 5.4.2 TRIM ー 空白を除去する
**▼空白を除去する関数**
```SQL
TRIM(文字列を表す列) -> 左右から空白を除去した文字列
LTRIM(文字列を表す列) -> 左側の空白を除去した文字列
RTRIM(文字列を表す列) -> 右側の空白を除去した文字列
```

**▼空白を除去したメモを取得する**
```SQL
SELECT メモ, TRIM(メモ) AS 空白除去したメモ FROM 家計簿
```

##### 5.4.3 REPLACE ー 指定文字を置換する
**▼文字列を置換する関数**
```SQL
REPLACE(置換対象の文字列, 置換前の部分文字列, 置換後の部分文字列)　->　置換処理された後の文字列
```

**▼メモの一部を置換する**
```SQL
UPDATE 家計簿 SET メモ = REPLACE(メモ, '購入', '買った')
```

##### 5.4.4 SUBSTRING／SUBSTR ー 一部を抽出する
文字列の一部分だけを取り出したい場合には、SUBSTRING関数またはSUBSTR関数を利用
**▼文字列の一部を抽出する関数**
```SQL
SUBSTRING(文字列を表す列, 抽出を開始する位置, 抽出する文字の数) -> 抽出された部分文字列
SUBSTR(文字列を表す列, 抽出を開始する位置, 抽出する文字の数) -> 抽出された部分文字列
```
▼費目列の1〜3文字目に「費」があるものを抽出
```SQL
SELECT * FROM 家計簿
WHERE SUBSTRING(費目, 1, 3) LIKE '%費%'
```

##### 5.4.5 CONCAT ー 文字列を連結する
文字列を連結するには、通常、||演算子や+演算子を使うが、CONCAT関数でも同様の処理ができる。連結できる文字列の数やNULLの扱いがDBMSによって異なる点は注意。

**▼文字列を連結する関数**
```SQL
CONCAT（文字列, 文字列 [, 文字列…]） -> 連結後の文字列
```

▼費目とメモをつなげて抽出する
```SQL
SELECT CONCAT(費目, ':' || メモ) FROM 家計簿
```
#### 5.5 数値にまつわる関数
##### 5.5.1 ROUND ー 指定桁で四捨五入
**▼指定桁で四捨五入する関数**
```SQL
ROUND(数値を表す列, 有効とする桁数) -> 四捨五入した値
```

**▼百円単位の出金額を取得する（四捨五入）**
```SQL
SELECT 出金額, ROUND(出金額, -2) AS 百円単位の出金額 FROM 家計簿
```
ROUND関数に-2を渡すと、出金額の下2桁目、10の位で四捨五入してくれる。

##### 5.5.2 TRUNC ー 指定桁で切り捨てる
▼指定桁で切り捨てる関数
```SQL
TRUNC(数値を表す列, 有効とする桁数) -> 切り捨てた値
```

**▼百円単位の出金額を取得する（四捨五入）**
```SQL
SELECT 出金額, TRUNC(出金額, -2) AS 百円単位の出金額 FROM 家計簿
```
##### 5.5.3 POWER ー べき乗を計算する
**▼べき乗を計算する関数**
```SQL
POWER(数値を表す列, 何乗するかを指定する数値) -> 数値を指定した回数だけ乗じた結果
```
#### 5.6 日付にまつわる関数
##### 5.6.1 現在の日時を得る
**▼現在の日時を得る関数**
```SQL
CURRENT_TIMESTANP => 現在の日時（年、月、日、時、分、秒）
CURRENT_DATE => 現在の日付（年、月、日）
CURRENT_TIME => 現在の時刻（時、分、秒）
```

**▼現在の日付を取得して登録する**
```SQL
INSERT INTO 家計簿
VALUES (CURRENT_DATE,  '食費', 'ドーナッツを買った', 0, 260)
```
#### 5.7 変換にまつわる関数
##### 5.7.1 CAST ー データ型を変換する
**▼データ型を変換する関数**
```SQL
CAST(変換する値 AS 変換する型) => 変換後の値
```

##### 5.7.2 COALESCE ー 最初に登場するNULLでない値を返す
▼
```sql
COALESCE (列や式1, 列や式2, 列や式3...) => 引数のうち、最初に現れたNULLでない引数
```

#### 5.8 この章のまとめ
**計算式**
- 列やリテラルを使った式で、結果が真または偽にならないものを計算式という。
- 計算式を評価すると計算結果に化ける
- 計算式は、SELECT文の選択列リスト、INSERT文やUPDATE文のテーブルに格納する値、その他の修飾句など、様々な場所で使用できる。
**計算式に用いる演算子**
- 四則演算を行う演算子を算出演算子という
- || 演算子や+演算子で文字列の連結ができる。
- CASE演算子は、列の値や条件式を評価して、任意の値に変換する。
**関数**
- 関数は、引数に対して決められた処理を行い、戻り値に化ける
- 関数は、処理の内容や戻り値に応じて、文字列関数、算術関数、日付関数、変換関数などに分類される。
- 関数は、DBMSによる違いが大きい機能であるため、各製品のマニュアルなどで処理内容の確認が不可欠である。
### Chapter6 集計とグループ化
#### 6.1 データを集計する
##### 
#### 6.2 集計関数の使い方
#### 6.3 集計に関する4つの注意点
#### 6.4 データをグループにわける
#### 6.5 集計テーブルの活用
#### 6.6 この章のまとめ

### Chapter7 副問い合わせ
### Chapter8 複数テーブルの結合