前回の続きでLaravelでToDoアプリ作っていく。


#### 5. コントローラーの処理を実装

**の前に、必要なビューファイルを作成**
▼ビューが必要なメソッド（GETリクエスト）
- `index()` - 一覧を表示 → `todos/index.blade.php`
- `create()` - 作成フォームを表示 → `todos/create.blade.php`
- `edit()` - 編集フォームを表示 → `todos/edit.blade.php`
- `show()` - 詳細を表示 → `todos/show.blade.php`

##### 1. `index()` - ToDoの一覧表示
▼コントローラ
```php
public function index()
{
    // ログイン中のユーザーのToDoを全件取得
    $todos = auth()->user()->todos()->latest()->get();
    return view('todos.index', compact('todos'));
}
```
**解説:**
- `auth()->user()` - ログイン中のユーザーオブジェクトを取得
- `->todos()` - Userモデルで定義した`hasMany`リレーションで、そのユーザーに紐づくToDoを取得
- `->latest()` - 最新順（降順）でソート。デフォルトではcreated_atでソート
- `->get()` - 実際にDBからデータを取得（これがないとクエリは実行されない）
- `view('todos.index', compact('todos'))` - `resources/views/todos/index.blade.php`を表示し、`$todos`変数を渡す

**ユースケース:** ユーザーが「/todos」にアクセスすると、自分のToDoが新しい順に一覧表示される

ところで、
「->」この書き方、JavaScriptのアローに似てるけどPHPだとどういう意味？
 **ChatGPT:**`->` は **PHP の「オブジェクトのプロパティ・メソッドへアクセスする記号」**
JSでいうところの「.」のようなもの。

---
##### 2. `create()` - 作成フォーム表示
```php
public function create()
{
    return view('todos.create');
}
```
**解説:**
- シンプルに`resources/views/todos/create.blade.php`を表示するだけ
- ここではDBアクセスは不要
- フォーム上で入力された内容は`store()`メソッドで処理される

**ユースケース:** ユーザーが「/todos/create」にアクセスすると、ToDoを作成するためのフォームが表示される

---
##### 3. `store()` - フォームデータをDBに保存
```php
public function store(Request $request)
{
    // バリデーション
    $validated = $request->validate([
        'title' => 'required|string|max:255',
        'description' => 'nullable|string',
    ]);

    // ログイン中のユーザーのToDoとして作成
    auth()->user()->todos()->create($validated);

    return redirect()->route('todos.index')->with('message', 'ToDoを作成しました。');
}
```

**バリデーションの詳細:**
- `'title' => 'required|string|max:255'`
    - `required` - titleは必須（空では不可）
    - `string` - 文字列型であること
    - `max:255` - 最大255文字まで
- `'description' => 'nullable|string'`
    - `nullable` - nullを許可（空白でOK）
    - `string` - 文字列型であること

**バリデーションエラー時の動作:** バリデーションに引っかかるとエラーメッセージがセッションに保存され、前のページにリダイレクトされる

**ToDoの作成:**
```php
auth()->user()->todos()->create($validated);
```
- `auth()->user()` - ログイン中のユーザー
- `->todos()` - そのユーザーのToDoリレーション
- `->create($validated)` - バリデーション済みのデータでToDoを作成
    - 自動的に`user_id`がセットされる（リレーションを使用しているため）

**リダイレクトとメッセージ:**
```php
return redirect()->route('todos.index')->with('success', 'ToDoを作成しました。');
```
- `redirect()->route('todos.index')` - `/todos`にリダイレクト
- `->with('success', 'ToDoを作成しました。')` - セッションにメッセージを保存
    - ビューで`{{ session('success') }}`で表示できる

**ユースケース:** ユーザーが作成フォームで「保存」ボタンを押すと、バリデーションされてDBに保存され、一覧ページにリダイレクトされる

---
##### 4. `show()` - 個別のToDoを表示
```php
public function show(Todo $todo)
{
    // ログイン中のユーザーのToDoかチェック
    $this->authorize('view', $todo);
    
    return view('todos.show', compact('todo'));
}
```

**ルートモデルバインディング:**

php

```php
public function show(Todo $todo)
```

- `/todos/1` にアクセスすると、自動的に`id=1`のTodoモデルがインジェクトされる
- 存在しないIDなら自動的に404エラー

**認可チェック:**

php

```php
$this->authorize('view', $todo);
```

- ログイン中のユーザーが、このToDoを閲覧する権限があるかチェック
- 権限がないと403エラー（後で詳しく説明します）

**ユースケース:** ユーザーが「/todos/1」にアクセスすると、id=1のToDoの詳細が表示される（ただし本人のToDoのみ）

---

##### 5. `edit()` - 編集フォーム表示

php

```php
public function edit(Todo $todo)
{
    // ログイン中のユーザーのToDoかチェック
    $this->authorize('update', $todo);
    
    return view('todos.edit', compact('todo'));
}
```

**解説:**

- `show()`と同じく、URLから自動的にTodoオブジェクトを取得
- `$this->authorize('update', $todo)` - 編集権限があるかチェック（自分のToDoか？）
- ビューに`$todo`を渡す（現在の値をフォームに表示するため）

**ユースケース:** ユーザーが「/todos/1/edit」にアクセスすると、id=1のToDoを編集するためのフォームが表示される（現在の値が入力済み）

---

##### 6. `update()` - 編集内容をDBに保存
```php
public function update(Request $request, Todo $todo)
{
    // ログイン中のユーザーのToDoかチェック
    $this->authorize('update', $todo);

    // バリデーション
    $validated = $request->validate([
        'title' => 'required|string|max:255',
        'description' => 'nullable|string',
        'is_completed' => 'boolean',
    ]);

    // 更新
    $todo->update($validated);

    return redirect()->route('todos.index')->with('success', 'ToDoを更新しました。');
}
```

**バリデーション:**

php

```php
'is_completed' => 'boolean',
```

- `store()`では`is_completed`をバリデーションしていないが、`update()`では追加
- 理由：編集フォームでは完了/未完了を切り替える可能性があるため

**データ更新:**

php

```php
$todo->update($validated);
```

- Todoモデルの`protected $fillable`で指定されたカラムのみ更新される
- `update()`メソッドで複数カラムを一度に更新できる

**ユースケース:** ユーザーが編集フォームで変更を加えて「保存」ボタンを押すと、DBが更新されて一覧ページにリダイレクトされる

---

##### 7. `destroy()` - ToDoを削除

php

```php
public function destroy(Todo $todo)
{
    // ログイン中のユーザーのToDoかチェック
    $this->authorize('delete', $todo);

    $todo->delete();

    return redirect()->route('todos.index')->with('success', 'ToDoを削除しました。');
}
```

**解説:**

- `$this->authorize('delete', $todo)` - 削除権限があるかチェック
- `$todo->delete()` - そのToDoレコードをDBから削除
- リダイレクトして完了メッセージを表示

**ユースケース:** ユーザーが削除ボタンをクリックすると、ToDoが削除されて一覧ページにリダイレクトされる

#### 4. ビューを作る
```bash
mkdir -p resources/views/todos
vim resources/views/todos/index.blade.php
```


