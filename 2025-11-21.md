# 2025/11/21 
## Laravelの教科書 
### Chapter8 
- リレーションの設定
- EloquentORMについて
	- Eloquent ＝雄弁な
	  ORM=Object-Relation Map
	  「オブジェクトと関連するものをマッピングするもの」
	- モデルを使って、関係するデータベースとの対応付を上手に行ってくれる機能

**条件にあったデータを取得する書き方**
`（モデル名）::where('条件をつけるカラム', '条件')->get();`

```PHP
Post::where('user_id', auth()->id())-get();
```

**条件に合わないデータを取得する書き方**
`（モデル名）::where('条件をつけるカラム', '!=' ,'条件')->get();`

**条件にあったデータを取得する書き方**
`（モデル名）::where('条件をつけるカラム', '条件')->get();`

**日付条件にあったデータを取得する書き方**
`（モデル名）::whereDate('条件をつけるカラム', '>または<', '条件')->get();`

例）2025年11月20日以降に作成された投稿データ取得
```PHP
Post::whereDate('created_at','>=', '2025-11-20')-get();
```

| メソッド         | 用途          | 例                                                           |
| ------------ | ----------- | ----------------------------------------------------------- |
| whereBetween | 2つの値の間      | user_idが1から5<br>whereBetween('user_id', [1, 5])             |
| whereIn      | 指定値のいずれかを含む | user_idが1か5<br>whereIn('user_id', [1, 5])                   |
| whereNull    | NULLのデータ    | user_idがNull<br>whereNull('user_id')                        |
| whereDate    | 日付条件を入れる    | 2022年12月2日より後<br>whereDate('created_at', '>', '2022-12-02') |
| whereMonth   | 月条件を入れる     | 12月より後<br>whereMonth('created_at', '>', '12')               |
| whereDay     | 日にち条件を入れる   | 2日より後<br>whereDay('created_at', '>', '2')                   |
| whereYear    | 年条件を入れる     | 2022年より後<br>whereYear('created_at', '>', '2022')            |
| whereTime    | 時間条件を入れる    | 9時より後<br>whereTime('created_at', '>', '09:00')              |

**複数のデータ取得条件を設定**

```PHP
Post::where('user_id', 1)->whereDate('created_at','>=', '2025-11-20')-get();
```
**orderByでデータの並び替え**

```PHP
Post::orderBy('created_at','desc')-get();
```
**firstやfindを使ってデータを取得**

```PHP
Post::whereDate('created_at','>=', '2025-11-20')-first();
```

‐‐‐
### Chapter9 ミドルウェアによるアクセス制限
#### 9-1 ミドルウェアってなに？

##### ミドルウェアとは
リクエストがルート設定で割り振られた後、コントローラで処理を行う前、またはコントローラで処理を行った後に処理を実行

▼処理の流れ
![[Pasted image 20251121114320.png]]
Laravelではよく使うミドルウェアは最初から入っている。

##### 設定場所と規定ミドルウェア
プロジェクト内のbootstrap/app.phpでアプリケーションのルーティング、ミドルウェア、例外ハンドリングを設定している。

```PHP 
<?php
	use Illuminate\Foundation\Application;
	use Illuminate\Foundation\Configuration\Exceptions;
	use Illuminate\Foundation\Configuration\Middleware;
	
	return Application::configure(basePath: dirname(__DIR__))
		->withRouting(
			//ルーティングの設定
			web: __DIR__.'/../routes/web.php',
			commands: __DIR__.'/../routes/console.php',
			health: '/up',
		)
		->withMiddleware(function (Middleware $middleware): void {
			//ミドルウェアの設定
		})
		->withExceptions(function (Exceptions $exceptions): void {
			//例外の設定
		})->create();
```

###### 認証系ミドルウェア（auth / verified / guest）
auth：ユーザーがログイン（認証）しているか、verified：ユーザーがメールアドレスの認証を完了しているかを判定。
適用したい場所でミドルウェアのエイリアスを指定するだけで使うことができる
▼web.php
```PHP
Route::view('dashboard', 'dashboard')
	->middleware(['auth','verified'])
	->name('dashboard')
```

###### CSRF保護ミドルウェア（validateCsrfTokens）
フォームを通じて投稿したときにCSRF対策を行ってくれる。
APIエンドポイントや外部サービスのWebhook（例：Stripe）ではCSRFトークンを送信できないため、ミドルウェアの対象外にする必要がある。

▼app.php
```PHP 
->withMiddleware(function (Middleware $middleware): void {
	$middleware->validateCsrfTokens(except: [
		'stripe/*',
	]);
})
```

###### 文字列トリミングミドルウェア（TrimStrings）
フォームを通じて投稿したときに、自動的に文字列の前後の空白を削除してくれるミドルウェア。初期設定では有効になっている。

▼app.php
```PHP 
use Illuminate\Foundation\Http\Middleware\TrimStrings;

->withMiddleware(function (Middleware $middleware): void {
	$middleware->remove([
	TrimStrings::class,
	])
})
```





#### 9-2 ミドルウェアで管理者のみをアクセス可能にする
ミドルウェアは自分で作成することも可能

`sail artisan make:middleware RoleMiddleware`
make:middleware で作れる

#### 9-3 Gate（ゲート）を使った動作や表示の制限
Gateは、処理を実行できるかどうかを判断してくれる機能。
##### Gateの設定
▼ /app/Providers/AppServiceProvider.php
```PHP
<?php
	namespace App\Providers;
	
	use Illuminate\Support\Facades\Gate; //Use宣言を追加
	use App\Models\User; //Use宣言を追加
	use Illuminate\Support\ServiceProvider;
	
	class AppServiceProvider extends ServiceProvider
	{
		/**
		* Register any application services.
		*/
		public function register(): void
		{
			Gate::define('test', function (User $user) {
				if ($user->role === 1) {
					return true;
				}
				return false;
			});
		}
		
		/**
		* Bootstrap any application services.
		  */
		public function boot(): void
		{
		//
		}
	}
```

##### ルートにGateをつけてアクセス制限
`ルート設定->middleware('can:ゲート名')`
##### ビューにGateをつけて表示を制限
`@can('ゲート名')
	制限をかけたい部分
@endcan`

##### コントローラにGateをつけて動作を制限
▼PostController.php
```PHP
	use Illuminate\Support\Facades\Gate;
	public function store(Request $request)
	{
		Gate::authorize('test');
```



### Chapter10 データの個別表示・編集・削除処理の搭載
#### 個別表示機能の搭載
##### パラメータを使った個別表示用のルート設定を追加
`Route::get('post/show/{post}', [PostController::class, 'show'])->name('post.show');`
##### コントローラでタイプヒントを使って引数を指定
タイプヒントとは？→変数や引数の型を指定すること。
LaravelではPost $postと==タイプヒントした後に引数を指定することで、投稿（posts）テーブルから、ルートパラメーターの数字がidとなる投稿（post）データをとてきてくれる==。これを**依存注入**という。
ルートパラメータの変数名と、引数名は同じものを使用しないとエラーになる。
##### 個別表示用のビューファイルの作成
##### 一覧画面にルート名を使ってリンクを追加
#### 編集機能の搭載
##### 編集と更新用のルート設定を追加
▼web.php
```PHP
Route::get('/post/{post}/edit',[PostController::class, 'edit'])->name('post.edit');

Route::patch('/post/{post}', [PostController::class, 'update'])->name('post.update');
```
データを変更するためのHTTPメソットはPUTまたはPATCH
**PUT:**
- コントローラ側では `$request->all()` で受け取ることが多い
- クライアント側は「リソース全体」を送る意識
**PATCH:**
- 一部だけ更新する場合に使用
- `$request->only(['name'])` みたいに、変更したい項目だけ取得する
##### 編集と更新用の処理を記述
▼PostController.php
```PHP
<?php
	use App\Models\Post;
	
	class PostController extends Controller
	{
		//editメソッドを追記
		public function edit(Post $post)
		{
			return view('post.edit', compact('post'));
		}
		
		//updateメソッドを追記
		public function update(Request $request, Post $post)
		{
			$validated = $request->validate([
				'title' => 'required|max:20',
				'body' => 'required|max:400',
			]);
			$validated['user_id'] = auth()->id();
			
			$post->update($validated);
			
			$request->session()->flash('message', '更新しました。');
			return back();
		}
	}
	
```
##### 編集画面用のビューファイルの作成
formタグの書き方
`<form method="post" action="{{ 'ルート名' }}">`
`@csrf`
`@method('HTTPメソッド名')`
##### 個別表示画面にルート名を使ってリンクを追加


#### 削除機能の搭載
##### 削除機能のルート設定を追加
▼web.php
```PHP
Route::delete('/post/{post}', [PostController::class, 'destroy'])->name('post.destroy');
```
##### 削除用の処理を追加
▼/app/Http/Contorolers/PostController.php
```PHP
use App\Models\Post;
class PostController extends Controller
{
	public function destroy(Post $post)
	{
		$post->delete();
		return redirect()->route('post.index')->with('message', '削除しました。');`
	}
```
##### 削除用のコードをビューファイルに追加
▼/resources/views/post/show.blade.php

#### リソースコントローラの利用
リソースコントローラって？
CRUD（作成・読み取り・更新・削除）機能をまとめて扱うためのコントローラのひな型
##### ルート設定とコントーラを無効にしておく
##### リソースコントローラ用のルート設定を追加
`php artisan make:controller コントローラ名 --resource --model='モデル名'`
```PHP
 php artisan make:controller PostController --resource --model=Post
```

ちゃんとルート設定が作成されているかの確認
`php aritsan route:list`
##### リソースコントローラの編集





## 番外編
### TILの記録にObsidian×Gitの設定をやったこと
1. GitHub上でTIL用リポジトリを作成
2. ローカルでGit Clone
3. クローンしたフォルダをObsidianで開く
4. 拡張機能のObsidian Gitをインストール
5. gitignoreにObsidian配下が入らないように設定


## 本日の感想
**リソースコントローラすごい！！！！**
