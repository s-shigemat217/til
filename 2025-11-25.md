前回の続きでLaravelでToDoアプリ作っていく。


## 5. コントローラーの処理を実装の続き

## 6.Policyの実装
### Step 1: ポリシークラスを作成
```bash
php artisan make:policy TodoPolicy --model=Todo
```
### Step 2: ポリシーに実装
`app/Policies/TodoPolicy.php`に以下を記述：

```php
<?php

namespace App\Policies;

use App\Models\Todo;
use App\Models\User;

class TodoPolicy
{
    // 編集権限のチェック
    public function update(User $user, Todo $todo): bool
    {
        return $user->id === $todo->user_id;
    }

    // 削除権限のチェック
    public function delete(User $user, Todo $todo): bool
    {
        return $user->id === $todo->user_id;
    }

    // 閲覧権限のチェック
    public function view(User $user, Todo $todo): bool
    {
        return $user->id === $todo->user_id;
    }
}
```

**ロジック：** ユーザーIDがToDoの`user_id`と一致すれば`true`、異なれば`false`

### Step 3: Controllerで使用

```php
public function edit(Todo $todo)
{
    $this->authorize('update', $todo);
    return view('todos.edit', compact('todo'));
}

public function update(Request $request, Todo $todo)
{
    $this->authorize('update', $todo);
    // 更新処理
}

public function destroy(Todo $todo)
{
    $this->authorize('delete', $todo);
    $todo->delete();
    // リダイレクト
}
```

**現在のアプリの構成：**
```
ミドルウェア（role）
    ↓
edit, update, destroy にのみ適用
    ↓
URLパラメータから todo を取得
    ↓
user_id が一致しなければ 403 エラー

**メリット：**

- ✅ セキュリティが堅牢（エラーケースを先に処理）
- ✅ ルーティングで権限管理が明確
- ✅ シンプルで理解しやすい
```


## 7.ミドルウェアの実装
### Step 1: ミドルウェアクラスを作成
```bash
php artisan make:middleware CheckTodoOwnership
```

### Step 2: ミドルウェアに実装

`app/Http/Middleware/CheckTodoOwnership.php`に以下を記述：

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class CheckTodoOwnership
{
    public function handle(Request $request, Closure $next): Response
    {
        // URLから{todo}パラメータを取得
        $todo = $request->route('todo');

        // ToDoが存在しており、ログイン中のユーザーが所有者か確認
        if ($todo && auth()->user()->id !== $todo->user_id) {
            abort(403, '権限がありません。');
        }

        return $next($request);
    }
}
```

#### 重要：エラーケースを先に処理：防御的プログラミング（Defensive Programming）
 基本原則：「**何が起こるか**」より「**何が起こらないべきか**」を先に処理する

**❌ 悪い例（成功ケースを先に書く）**
```php
if ($todo && auth()->user()->id === $todo->user_id) {
    return $next($request);  // 成功処理
}
abort(403);  // エラー処理
```

問題：条件を見落とすと、権限がない人も通ってしまう可能性

**✅ 良い例（エラーケースを先に処理）**
```php
if ($todo && auth()->user()->id !== $todo->user_id) {
    abort(403);  // エラー処理を先に明示的に処理
}
return $next($request);  // デフォルト処理（安全）
```

メリット：「許可すべきでないケース」を明確に処理するため、セキュリティが堅牢

**なぜセキュリティアプリでは重要か：**
- デフォルトは「**許可しない**」
- 条件を見落としても、権限がない状態が守られる

### Step 3: `bootstrap/app.php`に登録
`bootstrap/app.php`に登録することで、**Laravelが`'role'`というエイリアスを認識**します。

```php
use App\Http\Middleware\CheckTodoOwnership;

return Application::configure(basePath: dirname(__DIR__))
    ...
    ->withMiddleware(function (Middleware $middleware): void {
        $middleware->alias([
            'role' => CheckTodoOwnership::class,
        ]);
    })
    ...
```

### Step 4: `routes/web.php`で適用
```php
Route::middleware('auth')->group(function () {
    // ミドルウェア不要（全員アクセス可能）
    Route::get('todos', [TodoController::class, 'index'])->name('todos.index');
    Route::get('todos/create', [TodoController::class, 'create'])->name('todos.create');
    Route::post('todos', [TodoController::class, 'store'])->name('todos.store');

    // ミドルウェア適用（所有者のみアクセス可能）
    Route::middleware('role')->group(function () {
        Route::get('todos/{todo}/edit', [TodoController::class, 'edit'])->name('todos.edit');
        Route::patch('todos/{todo}', [TodoController::class, 'update'])->name('todos.update');
        Route::delete('todos/{todo}', [TodoController::class, 'destroy'])->name('todos.destroy');
    });

    Route::get('todos/{todo}', [TodoController::class, 'show'])->name('todos.show');
});
```

---

## Step8 テストデータ作成
