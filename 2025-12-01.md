# 2025-12-01 スッキリわかるSQL入門 第4版②
## 第1部 SQLを始めよう（つづき）

### Chapter4 検索結果の加工
#### 4.1 検索結果の加工
##### 4.1.1 SELECT文だけに可能な修飾
SELECT文専用の修飾は、大きく捉えれば、どれも「SELECT文によって得られた検索結果を様々な形に加工するためのもの」
#### 4.2 DISTINCT ー重複業を除外する
##### 4.2.1 値の一覧を得る
```SQL
SELECT DISTINCT 列名...
FROM テーブル名
```
DISTINCTはデータの種類を取得した場面で役に立つ。
DISTINCT修飾あ、他の修飾キーワード都市がって、SELECT分の最初に、選択列リストよりも先に書く必要がある。
#### 4.3 ORDER BY ー 結果を並び替える
##### 4.3.1 並び替えの基本
SELECT文の最後にORDER BY句を記述すると、指定した列の値を基準として並び替えた検索結果を取得できる。
```SQL
SELECT 列名... FROM テーブル名
ORDER BY 列名 並び順
```
※並び順には、ASCまたはDESCを指定。省略した場合ASCとなる。
▼例
```SQL
SELECT * FROM 家計簿
ORDER BY 日付 DESC
```

##### 4.3.2 複数の列を基準にした並び替え
ORDER BY句による並び替えでは、複数の列を感まで区切って指定できる。このような指定を行うと、最初に指定された列で並び替えて同じ値が複数行あれば、次に指定された列で並び替えが行われる。
▼例
```SQL
SELECT * FROM 家計簿
ORDER BY 入金額 DESC, 出金額 DESC
```
##### 4.3.3 列番号を指定した並び替え
▼例
```SQL
SELECT * FROM 家計簿
ORDER BY 4 DESC, 5 DESC
```
ORDER BY句における列指定に列番号を用いる場合、**SELECT文の選択列リストの記述を修正したり、テーブルの構成が変更になったりすると、並び替えの結果にも影響が及ぶ**点には注意が必要。→列番号を指定した並び替えはあまり使わない

##### 4.3.4 ORDER BYをつけないと
**ORDER BY句を付けないSELECT文では、結果表の並び順は、実質的にランダムである。**
「必ずこの順番で並べた結果がほしい」という場面では、ORDER BY句を忘れずに記述する必要がある。
#### 4.4 OFFSET - FETCH ー 行数を限定して取得する
##### 4.4.1 一部の行だけを得る。
▼行数を指定して取得
```SQL
SELECT 列名… FROM テーブル名
ORDER BY 列名…
OFFSET 先頭から除外する行数 ROWS
FETCH NEXT 取得行数 ROWS ONLY
```
OFFSET句には、戦闘から除外死体行数を記述。女がせずに1件目から取得したい場合には0を指定するか、DMBSによってはOFFSET句自体を省略できる。

▼例）出金額の高い順位3件を取得する
```SQL
SELECT 費目,出金額 FROM 家計簿
ORDER BY 出金額
OFFSET 0 ROWS
FETCH NEXT 3 ROWS ONLY
```
#### 4.5 集合演算子
##### 4.5.1 集合演算子とは
構造がよく似た複数のテーブルにSELECT文をそれぞれ送り、その結果を組み合わせたい場合には、集合演算子を活用して1つのSQL文で目的を達成することができる。
集合演算とは、SELECT文によって抽出した結果表を1つのデータの集合と捉え、その結果同士を足し合わせたり、共通部分を探したりするような演算を行ってくれるしくみのこと。
- UNION：和集合…2つの検索結果を足し合わせたもの
- EXCEPT（MINUS）；差集合→最初の検索結果から次の検索結果と重複する部分を取り除いたもの
- INTERSECT：積集合→2つの検索結果で重複するもの
##### 4.5.2 UNION ー 和集合を求める
▼
```SQL
SELECT 文1
UNION （ALL）
SELECT 文2
```
和集合の結果に重複行があった場合、UNION単独では重複行を1行にまとめるのに対し、UNION ALLでは超副業をまとめずにすべてそのまま返す。
```SQL
SELECT 費目, 入金額, 出金額 FROM 家計簿
UNION
SELECT 費目, 入金額, 出金額 FROM 家計簿アーカイブ
ORDER BY 2, 3, 1
```

**集合演算子を使える条件**
SELECTの結果を集合演算してまとめるときは、選択列リストの列数とそれぞれのデータ型が一致していなければならない。

**集合演算でORDER BY句を使うときの注意点**
- ORDER BY句は最後のSELECT文に記述する。
- 列番号以外（列名やASによる別名）で並び替えるには、1つのSELECT文に記述したものを指定する。

##### 4.5.3 EXCEPT／MINUS ー 差集合を求める
▼2つのSELECT文の結果の差を得る
```SQL
SELECT 文1
EXCEPT （ALL）
SELECT 文2
※oracleDBでは、MINUSキーワードを仕様する
```
差集合を求める場合は、SELECT文を記述する順番に注意が必要。

##### 4.5.4 INTERSECT ー 積集合を求める
積集合とは、2つのSELECT分に共通する行を集めた集合。
▼積集合
```SQL
SELECT 文1
INTERSECT （ALL）
SELECT 文2
```
ALLキーワードを付けると、重複した行をまとめずにそのまま返す。

#### 4.6 この章のまとめ
**検索結果の加工**
- SELECT文で取得したデータは、以下のような様座な形に加工できる。

| 加工内容       | キーワード                        |
| ---------- | ---------------------------- |
| 重複行を除外する   | DISTINCT                     |
| 結果を並び替える   | ORDER BY                     |
| 行を限定して取得する | OFFSET - FETCH               |
| 結果を集合演算する  | UNION、EXCEPT／MINUS、INTERSECT |
**集合演算子**
- 集合演算子は、複数のSELECT文の結果を使って集合演算を行う。
- UNIONは和集合、EXCEPTとMINUSは差集合、INTERSECTは積集合を求める
- 集合演算子を用いるには、列数とデータ型を一致させる必要がある。
- 酒豪演算子とORDER BY句を併用する際の特有の書き方に注意する。


